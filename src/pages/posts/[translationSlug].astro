---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import PostHeader from '../../components/PostHeader.astro';
import BackToTop from '../../components/BackToTop.astro';
import { getCollection } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '../../utils/reading-time';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.lang === 'zh-CN' && !data.draft);
  return posts.map((p) => ({ params: { translationSlug: p.data.translationSlug } }));
}

const { translationSlug } = Astro.params;
const all = await getCollection('posts');
const post = all.find((p) => p.data.lang === 'zh-CN' && p.data.translationSlug === translationSlug)!;
const counterpart = all.find((p) => p.data.lang === 'en' && p.data.translationSlug === translationSlug);
const { Content } = await post.render();

const readingMinutes = calculateReadingTime(post.body);
const readingTime = formatReadingTime(readingMinutes, 'zh-CN');

const alternates = {
  'zh-CN': new URL(`/posts/${translationSlug}/`, Astro.site ?? 'https://blog.konakona52.com/').href,
  ...(counterpart ? { en: new URL(`/en/posts/${translationSlug}/`, Astro.site ?? 'https://blog.konakona52.com/').href } : {})
};

const ogImageUrl = new URL(`/og/${translationSlug}.svg`, Astro.site ?? 'https://blog.konakona52.com/').href;
---

<Layout lang="zh-CN" title={post.data.title} description={post.data.description} alternates={alternates} ogImage={ogImageUrl}>
  <Header
    lang="zh-CN"
    disableEn={!counterpart}
    toZh={`/posts/${translationSlug}/`}
    toEn={counterpart ? `/en/posts/${translationSlug}/` : '/en/'}
  />
  <main>
    <article>
      <div class="animate">
        <PostHeader title={post.data.title} description={post.data.description} date={post.data.date} readingTime={readingTime} lang="zh-CN" />
      </div>
      <div class="prose animate">
        <Content />
      </div>
    </article>
  </main>
  <BackToTop lang="zh-CN" />
</Layout>

<style>
  .prose {
    margin-top: 2rem;
  }
</style>
