---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import Layout from '../../../layouts/Layout.astro';
import Header from '../../../components/Header.astro';
import PostHeader from '../../../components/PostHeader.astro';
import BackToTop from '../../../components/BackToTop.astro';
import MissingTranslationNotice from '../../../components/MissingTranslationNotice.astro';
import TableOfContents from '../../../components/TableOfContents.astro';
import { SITE } from '../../../site.config';

export const getStaticPaths = (async () => {
  const allPosts = await getCollection('posts', ({ data }) => !data.draft);
  const zhPosts = allPosts.filter(post => post.data.lang === 'zh-CN');

  return zhPosts.map(post => {
    const enPost = allPosts.find(
      p => p.data.lang === 'en' && p.data.translationSlug === post.data.translationSlug
    );

    return {
      params: { translationSlug: post.data.translationSlug },
      props: { post, hasEnTranslation: !!enPost }
    };
  });
}) satisfies GetStaticPaths;

const { post, hasEnTranslation } = Astro.props;
const { Content } = await post.render();

// Check if post is in a folder
const isInFolder = post.data.translationSlug.includes('/');
const parentFolderPath = isInFolder ? post.data.translationSlug.substring(0, post.data.translationSlug.lastIndexOf('/')) : null;

const alternates: Record<string, string> = {
  'zh-CN': new URL(`/zh/posts/${post.data.translationSlug}/`, SITE.domain).href
};

if (hasEnTranslation) {
  alternates.en = new URL(`/en/posts/${post.data.translationSlug}/`, SITE.domain).href;
}

const ogImageUrl = new URL(`/og/${post.data.translationSlug}.svg`, SITE.domain).href;
---

<Layout 
  lang="zh-CN"
  title={post.data.title}
  description={post.data.description}
  alternates={alternates}
  ogImage={ogImageUrl}
>
  <Header
    lang="zh-CN"
    disableEn={!hasEnTranslation}
    toZh={`/zh/posts/${post.data.translationSlug}/`}
    toEn={hasEnTranslation ? `/en/posts/${post.data.translationSlug}/` : '/en/'}
  />
  <main>
    <article>
      {parentFolderPath && (
        <nav class="parent-folder-nav animate">
          <a href={`/zh/folders/${parentFolderPath}/`} class="back-to-folder">
            ← 返回文件夹
          </a>
        </nav>
      )}
      <div class="animate">
        <PostHeader title={post.data.title} description={post.data.description} date={post.data.date} lang="zh-CN" />
      </div>
      {!hasEnTranslation && <MissingTranslationNotice lang="zh-CN" translationUrl={`/en/posts/${post.data.translationSlug}/`} />}
      <div class="prose animate">
        <Content />
      </div>
    </article>
  </main>
  <TableOfContents lang="zh-CN" />
  <BackToTop lang="zh-CN" />
</Layout>

<style>
  .parent-folder-nav {
    margin-bottom: 1.5rem;
  }

  .back-to-folder {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.2s;
  }

  .back-to-folder:hover {
    color: var(--link);
  }

  .prose {
    margin-top: 2rem;
  }
</style>
